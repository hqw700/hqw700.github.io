---
title: Android Emulator自定义内核版本显示不对问题修复
date: 2025/9/8 00:42
tag: [虚拟化, kernel]
category: [虚拟化]
excerpt: 自定义内核版本显示不对问题修复，内核版本显示-maybe-dirty，编译日期显示1970
---

## 一，内核源码下载和编译
- 下载源码
```
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/kernel/manifest  -b common-android13-5.15
```
- 编译
```
$ tools/bazel run //common-modules/virtual-device:virtual_device_aarch64_dist
```

## 二，虚机内运行
- 随AOSP系统打包
``` diff
device/generic/goldfish$ git diff 
diff --git a/arm64-kernel.mk b/arm64-kernel.mk
index 6326121..2a58a9b 100644
--- a/arm64-kernel.mk
+++ b/arm64-kernel.mk
@@ -1,9 +1,8 @@
 TARGET_KERNEL_USE ?= 5.15
 
-KERNEL_ARTIFACTS_PATH := kernel/prebuilts/$(TARGET_KERNEL_USE)/arm64
+KERNEL_ARTIFACTS_PATH := /mnt/data/code/kernel/common-android13-5.15/out/android13-5.15/dist
 
-VIRTUAL_DEVICE_KERNEL_MODULES_PATH := \
-    kernel/prebuilts/common-modules/virtual-device/$(TARGET_KERNEL_USE)/arm64
+VIRTUAL_DEVICE_KERNEL_MODULES_PATH := /mnt/data/code/kernel/common-android13-5.15/out/android13-5.15/dist
 
 # The list of modules to reach the second stage. For performance reasons we
 # don't want to put all modules into the ramdisk.
@@ -29,4 +28,4 @@ BOARD_VENDOR_KERNEL_MODULES := \
 BOARD_VENDOR_KERNEL_MODULES_BLOCKLIST_FILE := \
     device/generic/goldfish/kernel_modules.blocklist
 
-EMULATOR_KERNEL_FILE := $(KERNEL_ARTIFACTS_PATH)/kernel-$(TARGET_KERNEL_USE)-gz
+EMULATOR_KERNEL_FILE := $(KERNEL_ARTIFACTS_PATH)/Image.gz
```

## 三，问题
- 进行虚机后有异常弹窗
![](/img/blog/system-error-dialog.png)

- uname -a显示时间不对，分支名也不对。
```
emulator64_arm64:/ $ uname -a
Linux localhost 5.15.167-maybe-dirty #1 SMP PREEMPT Thu Jan 1 00:00:00 UTC 1970 aarch64 Toybox
```
## 四，修复
尝试了加入如下环境变量重新编译无效。
```
export SOURCE_DATE_EPOCH=$(date +%s)
export KBUILD_BUILD_TIMESTAMP=$(date +%s) 
```
最终问题是由于我有未提交代码导致-maybe-dirty，`--depth 1`浅克隆导致时间不对。
- 完整克隆内核代码
```
$ cd common
common$ git fetch aosp android13-5.15 --unshallow
```
- 重新编译
```
$ tools/bazel clean --expunge
$ tools/bazel build //common-modules/virtual-device:virtual_device_aarch64_dist
```
- 虚机内显示
```
dd
```

- 也可以通过运行strings命令查看
```
$ strings out/android13-5.15/dist/vmlinux | grep -m1 'SMP PREEMPT'

```

> 操作系统：Mac mini M4
> 编译机：Ubuntu-22.04 AMD 5800X
> 手机：emulator 36.1 ARM64 on Mac
> 源码版本：AOSP android-13.0.0_r74
> 内核版本：common-android13-5.15